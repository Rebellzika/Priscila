<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Financeiro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <style>
        /* Reset B√°sico e Vari√°veis CSS */
        :root {
            --color-primary: #2563eb; /* blue-600 */
            --color-primary-hover: #1d4ed8; /* blue-700 */
            --color-primary-light: #dbeafe; /* blue-100 */
            --color-primary-darktext: #1e40af; /* blue-800 */

            --color-secondary: #64748b; /* slate-500 */
            --color-secondary-hover: #475569; /* slate-600 */
            
            --color-danger: #ef4444; /* red-500 */
            --color-danger-hover: #dc2626; /* red-600 */
            --color-danger-light: #fee2e2; /* red-100 */
            --color-danger-darktext: #991b1b; /* red-800 */

            --color-success: #22c55e; /* green-500 */
            --color-success-light: #dcfce7; /* green-100 */
            --color-success-darktext: #166534; /* green-800 */
            
            --color-warning: #f59e0b; /* amber-500 */
            --color-warning-light: #fef3c7; /* amber-100 */
            --color-warning-darktext: #b45309; /* amber-700 */

            --color-text-base: #1f2937; /* gray-800 */
            --color-text-muted: #6b7280; /* gray-500 */
            --color-text-inverted: #ffffff;
            --color-text-placeholder: #9ca3af; /* gray-400 */
            
            --color-bg-base: #f3f4f6; /* gray-100 */
            --color-bg-card: #ffffff;
            --color-bg-input: #ffffff;
            --color-bg-hover: #e5e7eb; /* gray-200 */
            --color-bg-subtle-hover: rgba(0,0,0,0.03);
            
            --color-border: #d1d5db; /* gray-300 */
            --color-border-focus: var(--color-primary);

            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.25);
            --border-radius-sm: 0.25rem;
            --border-radius-md: 0.375rem;
            --border-radius-lg: 0.5rem;
            --border-radius-xl: 0.75rem;
            --border-radius-full: 9999px;
        }

        .dark {
            --color-primary: #3b82f6; /* blue-500 */
            --color-primary-hover: #2563eb; /* blue-600 */
            --color-primary-light: #1e3a8a; 
            --color-primary-darktext: #bfdbfe; 

            --color-danger-light: #7f1d1d; 
            --color-danger-darktext: #fecaca; 

            --color-success-light: #14532d; 
            --color-success-darktext: #bbf7d0; 

            --color-warning-light: #713f12; 
            --color-warning-darktext: #fef08a; 
            
            --color-text-base: #d1d5db; /* gray-300 */
            --color-text-muted: #9ca3af; /* gray-400 */
            --color-text-placeholder: #6b7280; /* gray-500 */

            --color-bg-base: #111827; /* gray-900 */
            --color-bg-card: #1f2937; /* gray-800 */
            --color-bg-input: #374151; /* gray-700 */
            --color-bg-hover: #374151; /* gray-700 */
            --color-bg-subtle-hover: rgba(255,255,255,0.05);
            
            --color-border: #4b5563; /* gray-600 */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-sans); line-height: 1.6; background-color: var(--color-bg-base); color: var(--color-text-base); transition: background-color 0.2s, color 0.2s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .min-h-screen { min-height: 100vh; }
        .h-screen { height: 100vh; }
        .w-full { width: 100%; }
        .flex-1 { flex: 1 1 0%; }
        .p-1 { padding: 0.25rem; } .p-2 { padding: 0.5rem; } .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; } .p-8 { padding: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; } .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; } .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; } .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .m-1 { margin: 0.25rem; } .m-2 { margin: 0.5rem; }
        .mt-1 { margin-top: 0.25rem; } .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; } .mt-6 { margin-top: 1.5rem; } .mt-8 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 0.25rem; } .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; } .mb-8 { margin-bottom: 2rem; }
        .ml-1 { margin-left: 0.25rem; } .ml-2 { margin-left: 0.5rem; } .mr-2 { margin-right: 0.5rem; }
        .space-x-1 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.25rem; }
        .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; }
        .space-x-3 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.75rem; }
        .space-y-1 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.25rem; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
        .text-xs { font-size: 0.75rem; } .text-sm { font-size: 0.875rem; } .text-lg { font-size: 1.125rem; } .text-xl { font-size: 1.25rem; } .text-2xl { font-size: 1.5rem; } .text-3xl { font-size: 1.875rem; } .text-4xl { font-size: 2.25rem; }
        .font-light { font-weight: 300; } .font-normal { font-weight: 400; } .font-medium { font-weight: 500; } .font-semibold { font-weight: 600; } .font-bold { font-weight: 700; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .text-center { text-align: center; } .text-left { text-align: left; } .text-right { text-align: right; }
        .uppercase { text-transform: uppercase; } .tracking-wider { letter-spacing: 0.05em; } .leading-none { line-height: 1; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } .break-all { word-break: break-all; }
        .text-white { color: var(--color-text-inverted); } .text-primary { color: var(--color-primary); } .text-danger { color: var(--color-danger); } .text-success { color: var(--color-success); } .text-warning { color: var(--color-warning); } .text-muted { color: var(--color-text-muted); } .text-base-color { color: var(--color-text-base); }
        .bg-card { background-color: var(--color-bg-card); } .bg-primary { background-color: var(--color-primary); } .bg-primary:hover:not(:disabled) { background-color: var(--color-primary-hover); }
        .bg-danger { background-color: var(--color-danger); } .bg-danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }
        .bg-gray-50 { background-color: #f9fafb; } .dark .bg-gray-700 { background-color: #374151; }
        .rounded-sm { border-radius: var(--border-radius-sm); } .rounded-md { border-radius: var(--border-radius-md); } .rounded-lg { border-radius: var(--border-radius-lg); } .rounded-xl { border-radius: var(--border-radius-xl); } .rounded-full { border-radius: var(--border-radius-full); }
        .border { border-width: 1px; border-style: solid; border-color: var(--color-border); }
        .shadow-sm { box-shadow: var(--shadow-sm); } .shadow-md { box-shadow: var(--shadow-md); } .shadow-lg { box-shadow: var(--shadow-lg); } .shadow-xl { box-shadow: var(--shadow-xl); } .shadow-2xl { box-shadow: var(--shadow-2xl); }
        
        input[type="email"], input[type="password"], input[type="text"], input[type="number"], input[type="date"], select {
            display: block; width: 100%; padding: 0.65rem 0.9rem; margin-top: 0.25rem;
            border: 1px solid var(--color-border); border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm);
            transition: border-color 0.2s, box-shadow 0.2s; background-color: var(--color-bg-input); color: var(--color-text-base);
            font-size: 0.875rem;
        }
        input::placeholder, textarea::placeholder { color: var(--color-text-placeholder); }
        input:focus, select:focus { outline: none; border-color: var(--color-border-focus); box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-border-focus) 30%, transparent); }
        input.invalid, select.invalid { border-color: var(--color-danger); }
        input.invalid:focus, select.invalid:focus { box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-danger) 30%, transparent); }

        button { cursor: pointer; transition: background-color 0.2s, opacity 0.2s, transform 0.1s; border: none; }
        button:active:not(:disabled) { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.65rem 1.25rem; border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm); font-size: 0.875rem; font-weight: 500; line-height: 1.25; }
        .btn-primary { color: var(--color-text-inverted); background-color: var(--color-primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-hover); }
        .btn-danger { color: var(--color-text-inverted); background-color: var(--color-danger); }
        .btn-danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }
        .btn-secondary { color: var(--color-text-base); background-color: #e5e7eb; border: 1px solid var(--color-border); }
        .dark .btn-secondary { background-color: #4b5563; }
        .btn-secondary:hover:not(:disabled) { background-color: #d1d5db; }
        .dark .btn-secondary:hover:not(:disabled) { background-color: #6b7280; }
        .btn-icon { background: none; border: none; padding: 0.5rem; border-radius: var(--border-radius-full); color: var(--color-text-muted); }
        .btn-icon:hover { background-color: var(--color-bg-subtle-hover); color: var(--color-primary); }
        .btn-icon svg.icon { width: 1.125rem; height: 1.125rem; } 
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }

        .bg-gradient-auth { background-image: linear-gradient(to bottom right, #020617, #1e293b); } 
        
        table { min-width: 100%; border-collapse: collapse; }
        .table-container { overflow-x: auto; background-color: var(--color-bg-card); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); }
        thead { background-color: color-mix(in srgb, var(--color-bg-card) 95%, var(--color-text-base) 5%); }
        th { padding: 0.85rem 1.25rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--color-border); white-space: nowrap;}
        td { padding: 0.85rem 1.25rem; font-size: 0.875rem; border-top: 1px solid var(--color-border); color: var(--color-text-base); }
        tbody tr:hover { background-color: var(--color-bg-subtle-hover); }
        .table-action-button { padding: 0.3rem; } 

        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.65); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; padding: 1rem; }
        .modal.open { display: flex; }
        .modal-content { background-color: var(--color-bg-card); padding: 1.75rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-2xl); width: 100%; max-width: 500px; transform: scale(0.95); opacity: 0; transition: transform 0.25s cubic-bezier(0.165, 0.84, 0.44, 1), opacity 0.25s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .modal.open .modal-content { transform: scale(1); opacity: 1; }

        .notification { position: fixed; top: 1.25rem; right: 1.25rem; padding: 1rem; border-radius: var(--border-radius-md); box-shadow: var(--shadow-lg); z-index: 1050; opacity: 0; transform: translateX(100%); transition: opacity 0.3s ease, transform 0.3s ease; color: var(--color-text-inverted); display: flex; align-items: center; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: var(--color-success); }
        .notification.error { background-color: var(--color-danger); }
        .notification-icon { margin-right: 0.5rem; }
        .notification-close-btn { background: none; border: none; color: inherit; margin-left: auto; padding-left: 0.75rem; font-size: 1.25rem; line-height: 1; opacity: 0.7; }
        .notification-close-btn:hover { opacity: 1; }


        #auth-screen { min-height: 100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:1rem; }
        #auth-screen .auth-card { width: 100%; max-width: 28rem; background-color: var(--color-bg-card); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-2xl); padding: 2rem; }

        #dashboard-screen { display: flex; height: 100vh; }
        #dashboard-screen aside { width: 16rem; background-color: var(--color-bg-card); padding: 1.5rem; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid var(--color-border); }
        #dashboard-screen main { flex: 1 1 0%; padding: 2rem; overflow-y: auto; }
        
        .sidebar-item { width: 100%; display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: var(--border-radius-md); transition: background-color 0.2s, color 0.2s; cursor:pointer; background:none; border:none; color: var(--color-text-base); font-weight: 500; }
        .sidebar-item:hover { background-color: var(--color-bg-subtle-hover); color: var(--color-primary); }
        .sidebar-item.active { background-color: var(--color-primary); color: var(--color-text-inverted); }
        .sidebar-item.active:hover { background-color: var(--color-primary-hover); }
        .sidebar-item svg.icon { width: 1.125rem; height: 1.125rem; margin-right: 0.75rem; opacity: 0.8; } 
        .sidebar-item.active svg.icon { opacity: 1; }


        .filter-context-btn { width: 100%; text-align: left; padding: 0.5rem 1rem; border-radius: var(--border-radius-md); font-size: 0.875rem; background:none; border:none; color: var(--color-text-base); }
        .filter-context-btn:hover { background-color: var(--color-bg-subtle-hover); }
        .filter-context-btn.active-context { background-color: color-mix(in srgb, var(--color-primary) 15%, transparent); color: var(--color-primary); font-weight: 600; }
        
        #toggle-balances-btn, #dark-mode-toggle, #toggle-registration-btn { /* Added #toggle-registration-btn */
            width: 100%; display: flex; align-items: center; justify-content: center; padding: 0.6rem 1rem;
            border-radius: var(--border-radius-md); font-size: 0.875rem; background-color: color-mix(in srgb, var(--color-bg-base) 80%, var(--color-bg-card)); color: var(--color-text-base); border: 1px solid var(--color-border);
        }
        #toggle-balances-btn:hover, #dark-mode-toggle:hover, #toggle-registration-btn:hover { background-color: color-mix(in srgb, var(--color-bg-base) 60%, var(--color-bg-card)); }
        #toggle-balances-btn svg.icon, #dark-mode-toggle svg.icon, #toggle-registration-btn svg.icon { width: 1.125rem; height: 1.125rem; margin-right: 0.5rem; }

        .form-field-error { color: var(--color-danger); font-size: 0.75rem; margin-top: 0.25rem; }
        
        .empty-state-container { text-align: center; padding: 2.5rem 1.5rem; border: 2px dashed var(--color-border); border-radius: var(--border-radius-lg); margin-top: 1.5rem; background-color: color-mix(in srgb, var(--color-bg-base) 50%, var(--color-bg-card)); }
        .empty-state-container p { margin-bottom: 1rem; color: var(--color-text-muted); font-size: 0.9rem; }
        
        .empty-state-icon {
            margin-bottom: 0.75rem;
            color: var(--color-text-muted);
            opacity: 0.6;
            text-align: center; 
        }
        .empty-state-icon svg.icon {
            width: 4.5rem; 
            height: 4.5rem; 
            display: block; 
            margin-left: auto;
            margin-right: auto;
        }

        .loader-sm {
            border: 3px solid color-mix(in srgb, var(--color-text-inverted) 20%, transparent);
            border-top-color: var(--color-text-inverted);
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        .loader-lg { 
            border: 4px solid color-mix(in srgb, var(--color-primary) 20%, transparent);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            width: 2.5rem; 
            height: 2.5rem; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .table-search-filter { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.25rem; align-items: flex-end; }
        .table-search-filter > div { flex: 1 1 200px; min-width: 180px; } 
        .table-search-filter input, .table-search-filter select { margin-top: 0; }
        .table-search-filter .btn { padding-top: 0.65rem; padding-bottom: 0.65rem; } 

        .pagination-controls { display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; gap: 0.5rem; }
        .pagination-controls button { min-width: 2.5rem; }
        .pagination-info { font-size: 0.875rem; color: var(--color-text-muted); margin: 0 0.5rem;}

        .overview-card { background-color: var(--color-bg-card); padding: 1.25rem; border-radius: var(--border-radius-xl); box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .overview-card-header { display: flex; align-items: center; color: var(--color-text-muted); font-size: 0.8rem; font-weight: 500; margin-bottom: 0.35rem; } 
        .overview-card-header svg.icon { width: 0.9rem; height: 0.9rem; margin-right: 0.4rem; opacity: 0.7; } 
        .overview-card-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.1rem; line-height: 1.2; } 
        .overview-card-change { font-size: 0.75rem; }
        .text-net-change-positive { color: var(--color-success); }
        .text-net-change-negative { color: var(--color-danger); }
        .account-summary-item span.font-medium { color: var(--color-text-base); } 

        /* Estilos para Relat√≥rio MEI */
        .mei-report-value { font-size: 2rem; font-weight: 700; color: var(--color-primary); margin-top: 0.5rem; margin-bottom: 1rem; }
        .mei-report-filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: flex-end; flex-wrap: wrap; }
        .mei-report-filters > div { flex: 1 1 150px; }
        .mei-report-note { font-size: 0.875rem; color: var(--color-text-muted); margin-top: 1.5rem; padding: 1rem; background-color: color-mix(in srgb, var(--color-bg-base) 80%, var(--color-bg-card)); border-radius: var(--border-radius-md); border: 1px solid var(--color-border); }
        
        /* Admin specific styles */
        #admin-controls-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); }
        #admin-controls-section h3 { font-size: 0.75rem; text-transform: uppercase; color: var(--color-text-muted); font-weight: 600; margin-bottom: 0.5rem; }


    </style>
</head>
<body>

    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center bg-gradient-auth p-4">
        <div class="auth-card"> 
            <h1 id="app-title-auth" class="text-4xl font-bold text-center text-base-color mb-2">Gestor Financeiro</h1>
            <p id="auth-subtitle" class="text-center text-muted mb-8">Acesse sua conta</p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-base-color">Email <span class="text-danger">*</span></label>
                    <input type="email" id="email" name="email" required placeholder="seu@email.com">
                    <p id="email-error" class="form-field-error hidden"></p>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-base-color">Senha <span class="text-danger">*</span></label>
                    <input type="password" id="password" name="password" required placeholder="********">
                    <p id="password-error" class="form-field-error hidden"></p>
                </div>
                <p id="auth-error" class="text-danger text-sm text-center hidden"></p>
                <button type="submit" id="auth-button" class="w-full btn btn-primary py-3">
                    Entrar
                </button>
            </form>
            <p id="registration-prompt" class="mt-8 text-center text-sm text-muted"> <!-- Added ID here -->
                <span id="auth-toggle-text">N√£o tem uma conta?</span>
                <button id="auth-toggle-button" class="font-medium text-primary ml-1">
                    Registre-se
                </button>
            </p>
        </div>
        <footer class="mt-8 text-center text-xs text-muted">
            <p>&copy; <span id="current-year"></span> Gestor Financeiro. Todos os direitos reservados.</p>
        </footer>
    </div>

    <div id="dashboard-screen" class="hidden flex h-screen">
        <aside>
            <div>
                <h2 id="app-title-dashboard" class="text-2xl font-bold text-primary mb-6">Gestor Financeiro</h2>
                <nav id="sidebar-nav" class="space-y-1">
                    <!-- Itens de navega√ß√£o -->
                </nav>
                <div class="mt-6">
                    <h3 class="text-xs uppercase text-muted font-semibold mb-2">Contexto</h3>
                    <div class="space-y-1">
                        <button data-context="all" class="filter-context-btn">Todos</button>
                        <button data-context="personal" class="filter-context-btn">Pessoal</button>
                        <button data-context="business" class="filter-context-btn">Empresarial</button>
                    </div>
                </div>
                <div class="mt-6 space-y-2">
                    <button id="toggle-balances-btn">
                        <!-- √çcone e texto -->
                    </button>
                    <button id="dark-mode-toggle">
                        <!-- √çcone e texto -->
                    </button>
                </div>
                <!-- Admin Controls Section Placeholder -->
                <div id="admin-controls-section" class="hidden">
                    <h3>Controles Admin</h3>
                    <div class="space-y-2">
                        <button id="toggle-registration-btn"> 
                            <!-- √çcone e texto din√¢mico -->
                        </button>
                    </div>
                </div>

            </div>
            <div class="mt-auto pt-4 border-t border"> 
                <p class="text-xs text-muted mb-1">Logado como:</p>
                <p id="user-email-display" class="text-sm font-medium truncate mb-2" title=""></p>
                <p class="text-xs text-muted mb-1">User ID:</p>
                <p id="user-id-display" class="text-xs font-mono break-all mb-2" title=""></p>
                <p id="user-role-display" class="text-xs text-muted mb-2">Papel: <span class="font-medium"></span></p>
                <button id="logout-button" class="w-full btn btn-danger py-2 mt-4"> 
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <main id="main-content" class="p-6 flex-1 overflow-y-auto">
            <!-- Conte√∫do da view -->
        </main>
    </div>

    <div id="modal-generic" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-semibold"></h3>
                <button id="modal-close-button" class="btn-icon text-muted" aria-label="Fechar modal">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <template id="account-form-template">
        <form class="space-y-4" novalidate>
            <div>
                <label for="accountName" class="block text-sm font-medium">Nome da Conta <span class="text-danger">*</span></label>
                <input type="text" id="accountName" name="name" required />
                <p data-for="name" class="form-field-error hidden"></p>
            </div>
            <div>
                <label for="accountType" class="block text-sm font-medium">Tipo <span class="text-danger">*</span></label>
                <select id="accountType" name="type">
                    <option value="personal">Pessoal</option>
                    <option value="business">Empresarial</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" class="modal-cancel-btn btn btn-secondary">Cancelar</button>
                <button type="submit" class="modal-save-btn btn btn-primary">Salvar</button>
            </div>
        </form>
    </template>

    <template id="category-form-template">
        <form class="space-y-4" novalidate>
            <div>
                <label for="categoryName" class="block text-sm font-medium">Nome da Categoria <span class="text-danger">*</span></label>
                <input type="text" id="categoryName" name="name" required />
                <p data-for="name" class="form-field-error hidden"></p>
            </div>
            <div>
                <label for="categoryType" class="block text-sm font-medium">Tipo de Categoria <span class="text-danger">*</span></label>
                <select id="categoryType" name="type">
                    <option value="expense">Despesa</option>
                    <option value="income">Receita</option>
                </select>
            </div>
            <div>
                <label for="categoryContext" class="block text-sm font-medium">Contexto <span class="text-danger">*</span></label>
                <select id="categoryContext" name="context">
                    <option value="personal">Pessoal</option>
                    <option value="business">Empresarial</option>
                    <option value="all">Ambos (Geral)</option> 
                </select>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" class="modal-cancel-btn btn btn-secondary">Cancelar</button>
                <button type="submit" class="modal-save-btn btn btn-primary">Salvar</button>
            </div>
        </form>
    </template>

    <template id="transaction-form-template">
        <form class="space-y-4" novalidate>
            <div>
                <label for="transactionType" class="block text-sm font-medium">Tipo de Transa√ß√£o <span class="text-danger">*</span></label>
                <select id="transactionType" name="type">
                    <option value="expense">Despesa</option>
                    <option value="income">Receita</option>
                    <option value="transfer">Transfer√™ncia</option>
                </select>
            </div>
            <div>
                <label for="transactionDescription" class="block text-sm font-medium">Descri√ß√£o <span class="text-danger">*</span></label>
                <input type="text" id="transactionDescription" name="description" required />
                <p data-for="description" class="form-field-error hidden"></p>
            </div>
            <div>
                <label for="transactionAmount" class="block text-sm font-medium">Valor <span class="text-danger">*</span></label>
                <input type="number" id="transactionAmount" name="amount" step="0.01" required min="0.01"/>
                <p data-for="amount" class="form-field-error hidden"></p>
            </div>
            <div>
                <label for="transactionDate" class="block text-sm font-medium">Data <span class="text-danger">*</span></label>
                <input type="date" id="transactionDate" name="date" required />
                <p data-for="date" class="form-field-error hidden"></p>
            </div>
            <div class="transaction-account-section"> 
                <label for="transactionAccountId" class="block text-sm font-medium">Conta <span class="text-danger">*</span></label>
                <select id="transactionAccountId" name="accountId" required>
                    <option value="">Selecione uma conta</option>
                </select>
                <p data-for="accountId" class="form-field-error hidden"></p>
            </div>
            <div class="transaction-category-section"> 
                <label for="transactionCategoryId" class="block text-sm font-medium">Categoria (Opcional)</label>
                <select id="transactionCategoryId" name="categoryId">
                    <option value="">Selecione uma categoria</option>
                </select>
            </div>
            <div class="transaction-transfer-section hidden space-y-4"> 
                <div>
                    <label for="transactionFromAccountId" class="block text-sm font-medium">Conta de Origem <span class="text-danger">*</span></label>
                    <select id="transactionFromAccountId" name="fromAccountId"> 
                        <option value="">Selecione a conta de origem</option>
                    </select>
                    <p data-for="fromAccountId" class="form-field-error hidden"></p>
                </div>
                <div>
                    <label for="transactionToAccountId" class="block text-sm font-medium">Conta de Destino <span class="text-danger">*</span></label>
                    <select id="transactionToAccountId" name="toAccountId"> 
                        <option value="">Selecione a conta de destino</option>
                    </select>
                    <p data-for="toAccountId" class="form-field-error hidden"></p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" class="modal-cancel-btn btn btn-secondary">Cancelar</button>
                <button type="submit" class="modal-save-btn btn btn-primary">Salvar</button>
            </div>
        </form>
    </template>

    <template id="confirmation-modal-template">
        <div>
            <p id="confirmation-message" class="my-4 text-base-color"></p>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" class="modal-cancel-btn btn btn-secondary">Cancelar</button>
                <button type="button" class="modal-confirm-btn btn btn-danger">Confirmar</button>
            </div>
        </div>
    </template>
    
    <template id="date-filter-template">
        <div class="table-search-filter">
            <div class="flex-1">
                <label for="search-input" class="block text-xs font-medium text-muted">Pesquisar</label>
                <input type="search" id="search-input" placeholder="Digite para pesquisar..." class="text-sm">
            </div>
            <div class="flex-1 date-filter-group"> 
                <label for="date-start-input" class="block text-xs font-medium text-muted">Data In√≠cio</label>
                <input type="date" id="date-start-input" class="text-sm">
            </div>
            <div class="flex-1 date-filter-group"> 
                <label for="date-end-input" class="block text-xs font-medium text-muted">Data Fim</label>
                <input type="date" id="date-end-input" class="text-sm">
            </div>
            <button id="clear-filters-btn" class="btn btn-secondary btn-sm" title="Limpar filtros">Limpar</button>
        </div>
    </template>

    <div id="notification-container" aria-live="assertive"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; 
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            query, 
            onSnapshot,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDilLVHv1d6iv_ClNwPtL14IZ9G64Gf9Ks", // Substitua pela sua API Key real
            authDomain: "financeirogg-8fd82.firebaseapp.com", // Substitua pelo seu Auth Domain real
            projectId: "financeirogg-8fd82", // Substitua pelo seu Project ID real
            storageBucket: "financeirogg-8fd82.appspot.com",  // Substitua pelo seu Storage Bucket real
            messagingSenderId: "208882420194", // Substitua pelo seu Messaging Sender ID real
            appId: "1:208882420194:web:dcc04f35a8f9418c5711bb", // Substitua pela sua App ID real
            measurementId: "G-S20XXLWPX7" // Opcional: Substitua pelo seu Measurement ID real
        };

        // Initialize Firebase
        const fbApp = initializeApp(firebaseConfig);
        const fbAuth = getAuth(fbApp);
        const fbDb = getFirestore(fbApp);
        const fbAnalytics = getAnalytics(fbApp); 
        setLogLevel('debug'); 

        // --- Global State and Constants ---
        const APP_NAME_CONST = "Gestor Financeiro";
        // !!! IMPORTANTE: Substitua "YOUR_ADMIN_FIREBASE_UID" pelo UID real do seu usu√°rio Admin no Firebase Authentication.
        // Voc√™ pode obter o UID no console do Firebase ap√≥s criar sua conta de administrador.
        const ADMIN_UID = "YOUR_ADMIN_FIREBASE_UID"; 
        
        let currentUser = null;
        let currentUserId = null;
        let userRole = 'member'; // Default role
        let registrationsEnabled = true; // Default, will be fetched from Firestore

        let accounts = [];
        let categories = [];
        let transactions = [];
        let currentView = 'overview'; 
        let currentModal = { type: null, mode: null, data: null, callback: null };
        let filterContext = 'all'; 
        let showBalances = true;
        let unsubscribes = []; 
        let currentSearchTerm = '';
        let currentStartDate = ''; 
        let currentEndDate = '';   
        let meiReportStartDate = ''; 
        let meiReportEndDate = '';   
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;

        // --- DOM Elements ---
        const authScreenEl = document.getElementById('auth-screen');
        const dashboardScreenEl = document.getElementById('dashboard-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authButton = document.getElementById('auth-button');
        const authError = document.getElementById('auth-error');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authToggleButton = document.getElementById('auth-toggle-button');
        const registrationPromptEl = document.getElementById('registration-prompt'); 
        const authSubtitle = document.getElementById('auth-subtitle');
        const mainContent = document.getElementById('main-content');
        const sidebarNav = document.getElementById('sidebar-nav');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const userRoleDisplay = document.getElementById('user-role-display').querySelector('span'); 
        const logoutButton = document.getElementById('logout-button');
        const currentYearSpan = document.getElementById('current-year');
        let modalGeneric = document.getElementById('modal-generic');
        let modalTitle = document.getElementById('modal-title');
        let modalBody = document.getElementById('modal-body');
        let modalCloseButton = document.getElementById('modal-close-button');
        const toggleBalancesBtn = document.getElementById('toggle-balances-btn');
        const darkModeToggleBtn = document.getElementById('dark-mode-toggle');
        const adminControlsSection = document.getElementById('admin-controls-section');
        const toggleRegistrationBtn = document.getElementById('toggle-registration-btn');


        // --- Icons ---
        const ICONS = {
            Home: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>',
            Archive: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>',
            List: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>',
            Briefcase: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>',
            PlusCircle: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            Edit: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>',
            Trash2: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>',
            Eye: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>',
            EyeOff: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.05 10.05 0 01-4.125 5.175m0 0l3.59 3.59M21 21L17.41 17.41"></path></svg>',
            Sun: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-15.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m15.66 8.66l-.707-.707M4.04 4.04l-.707-.707"></path><circle cx="12" cy="12" r="5"></circle></svg>',
            Moon: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>',
            Search: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>',
            Calendar: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>',
            ChevronLeft: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>',
            ChevronRight: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>',
            Spinner: '<svg class="animate-spin icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>',
            TrendingUp: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>',
            TrendingDown: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>',
            DollarSign: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            FileText: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
            UserPlus: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 11v5m0 0v5m0-5h5m-5 0h-5"></path></svg>', 
            UserMinus: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 11H8"></path></svg>',
            // NOVO √çCONE KANBAN: Um √≠cone simples de quadro de tarefas/colunas
            Kanban: '<svg aria-hidden="true" class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>'
        };

        // --- Utility Functions ---
        const showNotification = (message, type = 'success', duration = 3000) => {
            const notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) {
                console.error("Notification container not found!");
                return;
            }
            const notificationId = 'notif-' + Date.now();
            const notificationDiv = document.createElement('div');
            notificationDiv.id = notificationId;
            notificationDiv.className = `notification ${type}`; 
            notificationDiv.setAttribute('role', 'alert');
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'notification-icon';
            if (type === 'success') iconSpan.innerHTML = '‚úîÔ∏è'; 
            else if (type === 'error') iconSpan.innerHTML = '‚ùå';
            else if (type === 'warning') iconSpan.innerHTML = '‚ö†Ô∏è';
            notificationDiv.appendChild(iconSpan);

            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            notificationDiv.appendChild(messageSpan);
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.className = 'notification-close-btn';
            closeBtn.setAttribute('aria-label', 'Fechar notifica√ß√£o');
            closeBtn.onclick = () => {
                notificationDiv.classList.remove('show');
                setTimeout(() => notificationDiv.remove(), 300);
            };
            notificationDiv.appendChild(closeBtn);
            notificationContainer.appendChild(notificationDiv);
            requestAnimationFrame(() => { 
                notificationDiv.classList.add('show');
            });
            if (duration > 0) {
                setTimeout(() => {
                    notificationDiv.classList.remove('show');
                    setTimeout(() => notificationDiv.remove(), 300);
                }, duration);
            }
        };

        const formatCurrency = (value) => {
            if (!showBalances) return "R$ ‚Ä¢‚Ä¢‚Ä¢";
            if (typeof value !== 'number' || isNaN(value)) value = 0;
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const formatDate = (timestamp) => {
            if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
            try {
                return timestamp.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                console.error("Error formatting date:", timestamp, e);
                return 'Data Inv√°lida';
            }
        };
        
        const getFirebaseTimestamp = (dateString) => {
            if (!dateString) return Timestamp.now(); 
            try {
                const date = new Date(dateString.includes('T') ? dateString : dateString + "T00:00:00"); 
                if (isNaN(date.getTime())) {
                    console.warn("Invalid date string for Timestamp, using current date:", dateString);
                    return Timestamp.now();
                }
                return Timestamp.fromDate(date);
            } catch (e) {
                console.error("Error creating Firebase Timestamp from date string:", dateString, e);
                return Timestamp.now(); 
            }
        };

        const dateToInputFormat = (timestampOrDate) => {
            let date;
            if (timestampOrDate instanceof Timestamp) {
                date = timestampOrDate.toDate();
            } else if (timestampOrDate instanceof Date) {
                date = timestampOrDate;
            } else {
                console.warn("dateToInputFormat received invalid type, defaulting to now:", timestampOrDate);
                date = new Date();
            }
            try {
                return date.toISOString().split('T')[0];
            } catch (e) {
                console.error("Error converting to input format:", timestampOrDate, e);
                return new Date().toISOString().split('T')[0]; 
            }
        };


        const applyDarkModePreference = () => {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.body.classList.toggle('dark', isDarkMode);
            if (darkModeToggleBtn) {
                 darkModeToggleBtn.innerHTML = `
                    ${isDarkMode ? ICONS.Sun : ICONS.Moon}
                    <span>${isDarkMode ? 'Modo Claro' : 'Modo Escuro'}</span>`;
                 darkModeToggleBtn.setAttribute('aria-pressed', isDarkMode.toString());
            }
        };
        
        const validateForm = (form) => {
            let isValid = true;
            form.querySelectorAll('input[required], select[required]').forEach(input => {
                const errorEl = form.querySelector(`.form-field-error[data-for="${input.name}"]`);
                if (errorEl) {
                    errorEl.textContent = ''; 
                    errorEl.classList.add('hidden');
                }
                input.classList.remove('invalid');

                if (!input.value.trim() && input.required) { 
                    isValid = false;
                    if (errorEl) {
                        errorEl.textContent = 'Este campo √© obrigat√≥rio.';
                        errorEl.classList.remove('hidden');
                    }
                    input.classList.add('invalid');
                } else if (input.type === 'number') {
                    const numValue = parseFloat(input.value);
                    if (isNaN(numValue)) {
                        isValid = false;
                        if (errorEl) { errorEl.textContent = 'Por favor, insira um n√∫mero v√°lido.'; errorEl.classList.remove('hidden'); }
                        input.classList.add('invalid');
                    } else if (input.hasAttribute('min') && numValue < parseFloat(input.min)) {
                        isValid = false;
                        if (errorEl) { errorEl.textContent = `O valor deve ser no m√≠nimo ${input.min}.`; errorEl.classList.remove('hidden'); }
                        input.classList.add('invalid');
                    }
                } else if (input.type === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value)) {
                    isValid = false;
                    if (errorEl) { errorEl.textContent = 'Por favor, insira um email v√°lido.'; errorEl.classList.remove('hidden'); }
                    input.classList.add('invalid');
                }
            });

            if (form.id === 'transaction-form-template-instance' && form.elements.type?.value === 'transfer') {
                const fromAccEl = form.elements.fromAccountId;
                const toAccEl = form.elements.toAccountId;
                const fromErrorEl = form.querySelector('.form-field-error[data-for="fromAccountId"]');
                const toErrorEl = form.querySelector('.form-field-error[data-for="toAccountId"]');

                if (fromAccEl && !fromAccEl.value) {
                    isValid = false;
                    if (fromErrorEl) { fromErrorEl.textContent = 'Conta de origem obrigat√≥ria.'; fromErrorEl.classList.remove('hidden'); }
                    fromAccEl.classList.add('invalid');
                }
                if (toAccEl && !toAccEl.value) {
                    isValid = false;
                    if (toErrorEl) { toErrorEl.textContent = 'Conta de destino obrigat√≥ria.'; toErrorEl.classList.remove('hidden'); }
                    toAccEl.classList.add('invalid');
                }
                if (fromAccEl && toAccEl && fromAccEl.value && toAccEl.value && fromAccEl.value === toAccEl.value) {
                    isValid = false;
                    if (toErrorEl) { toErrorEl.textContent = 'Contas de origem e destino n√£o podem ser iguais.'; toErrorEl.classList.remove('hidden'); }
                    toAccEl.classList.add('invalid'); 
                }
            }
            return isValid;
        };
        
        // --- App Settings (Registration Toggle) ---
        const appSettingsRef = doc(fbDb, "app_config", "settings");

        const fetchRegistrationSettings = async () => {
            try {
                const docSnap = await getDoc(appSettingsRef);
                if (docSnap.exists()) {
                    registrationsEnabled = docSnap.data().registrationsEnabled === true; 
                } else {
                    registrationsEnabled = true;
                    console.log("App settings not found, defaulting registrations to enabled.");
                }
            } catch (error) {
                console.error("Error fetching registration settings:", error);
                registrationsEnabled = true; 
            }
            updateRegistrationToggleUI(); 
        };

        const updateRegistrationToggleUI = () => {
            if (registrationPromptEl) {
                registrationPromptEl.classList.toggle('hidden', !registrationsEnabled);
            }
            if (toggleRegistrationBtn) {
                toggleRegistrationBtn.innerHTML = `
                    ${registrationsEnabled ? ICONS.UserMinus : ICONS.UserPlus}
                    <span>${registrationsEnabled ? 'Desabilitar Registros' : 'Habilitar Registros'}</span>
                `;
            }
        };
        
        if (toggleRegistrationBtn) {
            toggleRegistrationBtn.addEventListener('click', async () => {
                if (userRole !== 'admin') {
                    showNotification("Apenas administradores podem alterar esta configura√ß√£o.", "error");
                    return;
                }
                const newRegState = !registrationsEnabled;
                try {
                    await setDoc(appSettingsRef, { registrationsEnabled: newRegState }, { merge: true });
                    registrationsEnabled = newRegState;
                    updateRegistrationToggleUI();
                    showNotification(`Registros ${newRegState ? 'habilitados' : 'desabilitados'}.`, 'success');
                } catch (error) {
                    console.error("Error updating registration settings:", error);
                    showNotification("Erro ao atualizar configura√ß√£o de registro.", "error");
                }
            });
        }


        // --- Authentication & User Profile ---
        let isLoginMode = true;

        const createUserProfile = async (user, roleToAssign) => {
            if (!user || !user.uid) {
                console.error("Cannot create profile: invalid user object.");
                return;
            }
            const userProfileRef = doc(fbDb, "users", user.uid);
            try {
                await setDoc(userProfileRef, {
                    uid: user.uid,
                    email: user.email,
                    role: roleToAssign,
                    createdAt: Timestamp.now()
                }, { merge: true }); 
                console.log(`Profile created/updated for user ${user.uid} with role ${roleToAssign}`);
            } catch (error) {
                console.error("Error creating user profile:", error);
            }
        };
        
        const fetchUserProfile = async (userId) => {
            if (!userId) return 'member'; 
            const userProfileRef = doc(fbDb, "users", userId);
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists() && docSnap.data().role) {
                    return docSnap.data().role;
                }
                if (userId !== ADMIN_UID) {
                    console.log(`No profile/role for ${userId}, assigning 'member'.`);
                    await createUserProfile({ uid: userId, email: fbAuth.currentUser?.email || 'N/A' }, 'member'); 
                    return 'member';
                }
                return 'member'; 
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return 'member'; 
            }
        };


        const updateAuthScreenVisibility = () => {
            if (registrationPromptEl) {
                registrationPromptEl.classList.toggle('hidden', !registrationsEnabled);
            }
        };
        
        const updateAuthUI = () => {
            authSubtitle.textContent = isLoginMode ? 'Acesse sua conta' : 'Crie uma nova conta';
            authButton.textContent = isLoginMode ? 'Entrar' : 'Registrar';
            authToggleText.textContent = isLoginMode ? 'N√£o tem uma conta?' : 'J√° tem uma conta?';
            authToggleButton.textContent = isLoginMode ? 'Registre-se' : 'Fa√ßa login';
            authError.classList.add('hidden'); authError.textContent = '';
            emailInput.classList.remove('invalid');
            passwordInput.classList.remove('invalid');
            const emailErrorEl = document.getElementById('email-error');
            const passwordErrorEl = document.getElementById('password-error');
            if (emailErrorEl) { emailErrorEl.classList.add('hidden'); emailErrorEl.textContent = '';}
            if (passwordErrorEl) { passwordErrorEl.classList.add('hidden'); passwordErrorEl.textContent = '';}
            updateAuthScreenVisibility(); 
        };

        authToggleButton.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            updateAuthUI();
            authForm.reset(); 
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateForm(authForm)) return;

            if (!isLoginMode && !registrationsEnabled && emailInput.value !== "EMAIL_DO_SEU_ADMIN_AQUI") { 
                 showNotification("Os registros est√£o temporariamente desabilitados.", "warning");
                 return;
            }


            authButton.disabled = true;
            authButton.innerHTML = `<span class="loader-sm mr-2"></span> ${isLoginMode ? 'Entrando...' : 'Registrando...'}`;
            authError.classList.add('hidden');
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(fbAuth, email, password);
                    showNotification('Login bem-sucedido!', 'success');
                } else {
                    const userCredential = await createUserWithEmailAndPassword(fbAuth, email, password);
                    await createUserProfile(userCredential.user, 'member'); 
                    showNotification('Cadastro bem-sucedido! Fa√ßa o login.', 'success');
                    isLoginMode = true; 
                    updateAuthUI();
                    authForm.reset();
                }
            } catch (err) {
                console.error("Authentication error:", err.code, err.message);
                const firebaseErrorMessages = {
                    "auth/invalid-email": "O formato do email √© inv√°lido.",
                    "auth/user-disabled": "Este usu√°rio foi desabilitado.",
                    "auth/user-not-found": "Nenhum usu√°rio encontrado com este email.",
                    "auth/wrong-password": "Senha incorreta.",
                    "auth/email-already-in-use": "Este email j√° est√° em uso.",
                    "auth/operation-not-allowed": "Opera√ß√£o n√£o permitida. Verifique as configura√ß√µes de autentica√ß√£o.",
                    "auth/weak-password": "A senha √© muito fraca. Use pelo menos 6 caracteres.",
                    "auth/too-many-requests": "Muitas tentativas de login. Tente novamente mais tarde."
                };
                const friendlyMessage = firebaseErrorMessages[err.code] || "Ocorreu um erro de autentica√ß√£o. Tente novamente.";
                authError.textContent = friendlyMessage;
                authError.classList.remove('hidden');
                showNotification(friendlyMessage, 'error', 5000);
            } finally {
                authButton.disabled = false;
                authButton.textContent = isLoginMode ? 'Entrar' : 'Registrar';
            }
        });

        logoutButton.addEventListener('click', () => {
            openConfirmationModal("Tem certeza que deseja sair?", async () => {
                try {
                    await signOut(fbAuth);
                    showNotification('Logout bem-sucedido!', 'success');
                } catch (error) {
                    console.error("Error logging out: ", error);
                    showNotification('Erro ao fazer logout: ' + error.message, 'error');
                }
            });
        });
        
        // --- Navigation and View Rendering ---
        const navigateTo = (viewName) => {
            currentView = viewName;
            currentPage = 1; 
            currentSearchTerm = ''; 
            
            if (viewName === 'transactions' || viewName === 'accounts' || viewName === 'categories') {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                currentStartDate = dateToInputFormat(firstDay);
                currentEndDate = dateToInputFormat(lastDay);
            } else {
                currentStartDate = '';
                currentEndDate = '';
            }

            if (viewName === 'meiReport') {
                const today = new Date();
                meiReportStartDate = dateToInputFormat(new Date(today.getFullYear(), 0, 1)); 
                meiReportEndDate = dateToInputFormat(new Date(today.getFullYear(), 11, 31)); 
            }

            renderCurrentView();
            updateSidebarActiveState();
        };

        const updateSidebarActiveState = () => {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                // Para links externos, n√£o h√° estado 'active' pois eles n√£o mudam a 'currentView' interna
                if (item.dataset.view === currentView && !item.dataset.type) {
                     item.classList.add('active');
                }
            });
        };
        
        const updateFilterContextButtons = () => {
            document.querySelectorAll('.filter-context-btn').forEach(btn => {
                btn.classList.toggle('active-context', btn.dataset.context === filterContext);
            });
        };

        const renderSidebar = () => {
            const navItems = [
                { view: 'overview', label: 'Vis√£o Geral', icon: ICONS.Home },
                { view: 'accounts', label: 'Contas', icon: ICONS.Archive },
                { view: 'transactions', label: 'Transa√ß√µes', icon: ICONS.List },
                { view: 'categories', label: 'Categorias', icon: ICONS.Briefcase },
                { view: 'meiReport', label: 'Relat√≥rio MEI', icon: ICONS.FileText }, 
                // NOVO ITEM KANBAN
                { type: 'externalLink', href: 'https://rebellzika.github.io/Kanbanpri/', label: 'Kanban', icon: ICONS.Kanban }
            ];
            sidebarNav.innerHTML = navItems.map(item => {
                if (item.type === 'externalLink') {
                    return `
                        <a href="${item.href}" target="_blank" rel="noopener noreferrer" class="sidebar-item" aria-label="${item.label}">
                            ${item.icon}
                            <span>${item.label}</span>
                        </a>`;
                }
                return `
                    <button data-view="${item.view}" class="sidebar-item" aria-label="${item.label}">
                        ${item.icon}
                        <span>${item.label}</span>
                    </button>`;
            }).join('');

            document.querySelectorAll('.sidebar-item').forEach(buttonOrLink => {
                // Apenas adicione event listener para bot√µes de navega√ß√£o interna
                if (buttonOrLink.tagName === 'BUTTON' && buttonOrLink.dataset.view) {
                    buttonOrLink.addEventListener('click', () => navigateTo(buttonOrLink.dataset.view));
                }
                // Links <a> j√° funcionar√£o nativamente para abrir em nova aba
            });
            updateSidebarActiveState();
        };
        
        const renderToggleBalancesButton = () => {
            toggleBalancesBtn.innerHTML = `
                ${showBalances ? ICONS.EyeOff : ICONS.Eye}
                <span>${showBalances ? "Ocultar Saldos" : "Mostrar Saldos"}</span>
            `;
            toggleBalancesBtn.setAttribute('aria-pressed', showBalances.toString());
        };

        // --- Firestore Data Handling ---
        const getCollectionPath = (collectionName) => {
            if (!currentUserId) {
                console.error("currentUserId is null when trying to get collection path.");
                throw new Error("User not authenticated.");
            }
            return `users/${currentUserId}/${collectionName}`;
        };
        
        let dataLoadingStates = { accounts: true, categories: true, transactions: true };

        const fetchData = (collectionName, setter, callback) => {
            if (!currentUserId) {
                console.warn(`Attempting to fetch ${collectionName} without currentUserId.`);
                dataLoadingStates[collectionName] = false;
                if (currentView !== 'auth') renderCurrentView();
                return;
            }
            dataLoadingStates[collectionName] = true;
            if (mainContent && (!mainContent.innerHTML || mainContent.innerHTML.includes('empty-state') || mainContent.innerHTML.includes('Carregando'))) { 
                 if (currentView !== 'auth') renderCurrentView(); 
            }

            const path = getCollectionPath(collectionName);
            const q = query(collection(fbDb, path)); 

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const items = [];
                querySnapshot.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
                
                if (collectionName === 'transactions') {
                    items.sort((a, b) => (b.date?.toDate?.() || 0) - (a.date?.toDate?.() || 0));
                } else if (collectionName === 'accounts' || collectionName === 'categories') {
                    items.sort((a, b) => (a.name || "").localeCompare(b.name || "", undefined, { sensitivity: 'base' }));
                }
                
                setter(items);
                dataLoadingStates[collectionName] = false;
                if (callback) callback();
                if (currentView !== 'auth') renderCurrentView(); 
            }, (error) => {
                console.error(`Error fetching ${collectionName}: `, error);
                showNotification(`Erro ao buscar ${collectionName}: ${error.message}`, 'error');
                dataLoadingStates[collectionName] = false;
                if (currentView !== 'auth') renderCurrentView();
            });
            unsubscribes.push(unsubscribe); 
        };
        
        const cleanupFirestoreListeners = () => {
            console.log("Cleaning up Firestore listeners:", unsubscribes.length);
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
        };

        const calculateBalance = (accountId) => transactions.reduce((balance, transaction) => {
            const amount = parseFloat(transaction.amount || 0);
            if (isNaN(amount)) return balance; 
            if (transaction.type === 'income' && transaction.accountId === accountId) return balance + amount;
            if (transaction.type === 'expense' && transaction.accountId === accountId) return balance - amount;
            if (transaction.type === 'transfer') {
                if (transaction.toAccountId === accountId) return balance + amount;
                if (transaction.fromAccountId === accountId) return balance - amount;
            }
            return balance;
        }, 0);
        
        // --- Filtering and Pagination ---
        const getFilteredAndPaginatedData = (sourceItems, itemType) => { 
            let filteredItems = [...sourceItems]; 

            if (filterContext !== 'all') {
                if (itemType === 'transactions') {
                    filteredItems = filteredItems.filter(trans => {
                        const accountId = trans.accountId || trans.fromAccountId; 
                        const account = accounts.find(acc => acc.id === accountId);
                        return account && account.type === filterContext;
                    });
                } else if (itemType === 'accounts') {
                    filteredItems = filteredItems.filter(acc => acc.type === filterContext);
                } else if (itemType === 'categories') {
                    filteredItems = filteredItems.filter(cat => cat.context === filterContext || cat.context === 'all'); 
                }
            }

            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                filteredItems = filteredItems.filter(item => {
                    if (itemType === 'transactions') return (item.description || "").toLowerCase().includes(searchTermLower);
                    return (item.name || "").toLowerCase().includes(searchTermLower); 
                });
            }

            if (itemType === 'transactions') {
                if (currentStartDate) {
                    const startDateFilter = getFirebaseTimestamp(currentStartDate).toDate();
                    startDateFilter.setHours(0,0,0,0); 
                    filteredItems = filteredItems.filter(item => item.date && item.date.toDate() >= startDateFilter);
                }
                if (currentEndDate) {
                    const endDateFilter = getFirebaseTimestamp(currentEndDate).toDate();
                    endDateFilter.setHours(23,59,59,999); 
                    filteredItems = filteredItems.filter(item => item.date && item.date.toDate() <= endDateFilter);
                }
            }
            
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const paginatedItems = filteredItems.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

            return { items: paginatedItems, totalItems, totalPages };
        };

        const renderPaginationControls = (totalItems, totalPages, itemTypeForLabel) => {
            if (totalPages <= 1) return '';
            return `
                <div class="pagination-controls">
                    <button id="prev-page-btn" class="btn btn-secondary btn-sm" ${currentPage === 1 ? 'disabled' : ''} aria-label="P√°gina anterior">${ICONS.ChevronLeft} Anterior</button>
                    <span class="pagination-info">P√°gina ${currentPage} de ${totalPages} (${totalItems} ${itemTypeForLabel})</span>
                    <button id="next-page-btn" class="btn btn-secondary btn-sm" ${currentPage === totalPages ? 'disabled' : ''} aria-label="Pr√≥xima p√°gina">Pr√≥xima ${ICONS.ChevronRight}</button>
                </div>
            `;
        };

        const addPaginationListeners = (totalPages) => {
            document.getElementById('prev-page-btn')?.addEventListener('click', () => {
                if (currentPage > 1) { currentPage--; renderCurrentView(); }
            });
            document.getElementById('next-page-btn')?.addEventListener('click', () => {
                if (currentPage < totalPages) { currentPage++; renderCurrentView(); }
            });
        };
        
        const renderSearchAndDateFilters = (itemType) => {
            if (itemType === 'meiReport' || (itemType !== 'transactions' && itemType !== 'accounts' && itemType !== 'categories')) return ''; 

            const dateFilterTemplate = document.getElementById('date-filter-template').content.cloneNode(true);
            const searchInput = dateFilterTemplate.getElementById('search-input');
            const dateStartInput = dateFilterTemplate.getElementById('date-start-input');
            const dateEndInput = dateFilterTemplate.getElementById('date-end-input');
            
            searchInput.value = currentSearchTerm;
            searchInput.placeholder = itemType === 'transactions' ? 'Pesquisar Descri√ß√£o...' : 'Pesquisar Nome...';
            
            if (itemType === 'transactions') { 
                dateStartInput.value = currentStartDate;
                dateEndInput.value = currentEndDate;
            } else { 
                dateFilterTemplate.querySelectorAll('.date-filter-group').forEach(el => el.classList.add('hidden'));
            }

            const tempDiv = document.createElement('div');
            tempDiv.appendChild(dateFilterTemplate);
            return tempDiv.innerHTML;
        };

        const addSearchAndDateFilterListeners = (itemType) => {
            if (itemType === 'meiReport') return;

            const searchInput = mainContent.querySelector('#search-input');
            const dateStartInput = mainContent.querySelector('#date-start-input');
            const dateEndInput = mainContent.querySelector('#date-end-input');
            const clearFiltersBtn = mainContent.querySelector('#clear-filters-btn');

            searchInput?.addEventListener('input', (e) => {
                currentSearchTerm = e.target.value;
                currentPage = 1; 
                renderCurrentView();
            });

            if (itemType === 'transactions') {
                dateStartInput?.addEventListener('change', (e) => {
                    currentStartDate = e.target.value;
                    currentPage = 1;
                    renderCurrentView();
                });
                dateEndInput?.addEventListener('change', (e) => {
                    currentEndDate = e.target.value;
                    currentPage = 1;
                    renderCurrentView();
                });
            }
            
            clearFiltersBtn?.addEventListener('click', () => {
                currentSearchTerm = '';
                if (itemType === 'transactions') { 
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    currentStartDate = dateToInputFormat(firstDay);
                    currentEndDate = dateToInputFormat(lastDay);
                } else { 
                    currentStartDate = '';
                    currentEndDate = '';
                }
                currentPage = 1;
                if(searchInput) searchInput.value = '';
                if(dateStartInput && itemType === 'transactions') dateStartInput.value = currentStartDate; else if(dateStartInput) dateStartInput.value = '';
                if(dateEndInput && itemType === 'transactions') dateEndInput.value = currentEndDate; else if(dateEndInput) dateEndInput.value = '';
                renderCurrentView();
            });
        };

        const createEmptyState = (itemTypeSingular, itemTypePlural, addFunction, iconSvg = ICONS.Briefcase) => {
            return `
                <div class="empty-state-container">
                    <div class="empty-state-icon">${iconSvg}</div> 
                    <p>Nenhum(a) ${itemTypePlural.toLowerCase()} cadastrado(a) ainda.</p>
                    ${addFunction ? `<button class="btn btn-primary add-new-in-empty-state">
                        ${ICONS.PlusCircle} <span>Adicionar Novo(a) ${itemTypeSingular}</span>
                    </button>` : ''}
                </div>
            `;
        };

        // --- View Rendering Functions ---
        const renderOverview = () => {
             if (dataLoadingStates.accounts || dataLoadingStates.transactions) {
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader-lg"></div> <span class="ml-3 text-muted">Carregando vis√£o geral...</span></div>`;
                return;
            }
            const allAccountsForTotals = accounts; 
            const totalPersonal = allAccountsForTotals.filter(acc => acc.type === 'personal').reduce((sum, acc) => sum + calculateBalance(acc.id), 0);
            const totalBusiness = allAccountsForTotals.filter(acc => acc.type === 'business').reduce((sum, acc) => sum + calculateBalance(acc.id), 0);
            const totalOverall = totalPersonal + totalBusiness;
            
            const today = new Date();
            const firstDayCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayCurrentMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            const transactionsCurrentMonth = transactions.filter(t => {
                const tDate = t.date?.toDate();
                return tDate && tDate >= firstDayCurrentMonth && tDate <= lastDayCurrentMonth;
            });
            
            const contextFilteredTransactionsForCards = filterContext === 'all' 
                ? transactionsCurrentMonth 
                : transactionsCurrentMonth.filter(trans => {
                    const accountId = trans.accountId || trans.fromAccountId;
                    const account = accounts.find(acc => acc.id === accountId);
                    return account && account.type === filterContext;
                });

            const incomeCurrentMonth = contextFilteredTransactionsForCards.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const expensesCurrentMonth = contextFilteredTransactionsForCards.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const netChangeCurrentMonth = incomeCurrentMonth - expensesCurrentMonth;
            const { items: displayAccountsForContextSummary } = getFilteredAndPaginatedData(accounts, 'accounts');

            mainContent.innerHTML = `
                <h1 class="text-3xl font-semibold mb-6">Vis√£o Geral</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="overview-card"><div class="overview-card-header">${ICONS.Archive} <span>Saldo Total (Geral)</span></div><p class="overview-card-value ${totalOverall >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(totalOverall)}</p></div>
                    <div class="overview-card"><div class="overview-card-header">${ICONS.Home} <span>Saldo Pessoal</span></div><p class="overview-card-value ${totalPersonal >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(totalPersonal)}</p></div>
                    <div class="overview-card"><div class="overview-card-header">${ICONS.Briefcase} <span>Saldo Empresarial</span></div><p class="overview-card-value ${totalBusiness >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(totalBusiness)}</p></div>
                    <div class="overview-card"><div class="overview-card-header">${ICONS.TrendingUp} <span>Receitas (M√™s Atual - ${filterContext === 'all' ? 'Geral' : filterContext === 'personal' ? 'Pessoal' : 'Empresarial'})</span></div><p class="overview-card-value text-success">${formatCurrency(incomeCurrentMonth)}</p></div>
                    <div class="overview-card"><div class="overview-card-header">${ICONS.TrendingDown} <span>Despesas (M√™s Atual - ${filterContext === 'all' ? 'Geral' : filterContext === 'personal' ? 'Pessoal' : 'Empresarial'})</span></div><p class="overview-card-value text-danger">${formatCurrency(expensesCurrentMonth)}</p></div>
                    <div class="overview-card"><div class="overview-card-header">${ICONS.DollarSign} <span>Balan√ßo (M√™s Atual - ${filterContext === 'all' ? 'Geral' : filterContext === 'personal' ? 'Pessoal' : 'Empresarial'})</span></div><p class="overview-card-value ${netChangeCurrentMonth >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(netChangeCurrentMonth)}</p></div>
                </div>
                <div class="bg-card p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Resumo das Contas (${filterContext === 'all' ? 'Todas' : filterContext === 'personal' ? 'Pessoais' : 'Empresariais'})</h3>
                    ${displayAccountsForContextSummary.length > 0 ? `<ul class="space-y-3">${displayAccountsForContextSummary.map(acc => `<li class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg account-summary-item"><div><span class="font-medium text-base-color">${acc.name}</span><span class="ml-2 text-xs px-2 py-0.5 rounded-full ${acc.type === 'personal' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'}">${acc.type === 'personal' ? 'Pessoal' : 'Empresarial'}</span></div><span class="font-semibold ${calculateBalance(acc.id) >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(calculateBalance(acc.id))}</span></li>`).join('')}</ul>` : '<p class="text-muted">Nenhuma conta para exibir neste contexto.</p>'}
                </div>
                <div class="bg-card p-6 rounded-xl shadow-lg mt-6">
                    <h3 class="text-xl font-semibold mb-4">Dica R√°pida</h3>
                    <p class="text-muted">Seu balan√ßo do m√™s atual (${filterContext === 'all' ? 'Geral' : filterContext === 'personal' ? 'Pessoal' : 'Empresarial'}) est√° <span class="${netChangeCurrentMonth >=0 ? 'text-success font-semibold' : 'text-danger font-semibold'}">${netChangeCurrentMonth >=0 ? 'positivo' : 'negativo'}</span> em ${formatCurrency(Math.abs(netChangeCurrentMonth))}. Continue acompanhando!</p>
                </div>`;
        };

        const renderAccounts = () => {
            if (dataLoadingStates.accounts) { mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader-lg"></div> <span class="ml-3 text-muted">Carregando contas...</span></div>`; return; }
            const { items: displayAccounts, totalItems, totalPages } = getFilteredAndPaginatedData(accounts, 'accounts');
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-semibold">Contas</h1><button id="add-account-btn" class="btn btn-primary flex items-center space-x-2">${ICONS.PlusCircle}<span>Adicionar Conta</span></button></div>
                ${renderSearchAndDateFilters('accounts')}
                ${displayAccounts.length === 0 && totalItems === 0 && !currentSearchTerm ? createEmptyState('Conta', 'Contas', () => openFormModal('accounts', 'add'), ICONS.Archive) : 
                displayAccounts.length === 0 && (totalItems > 0 || currentSearchTerm) ? '<p class="text-center text-muted mt-4">Nenhuma conta encontrada com os filtros atuais.</p>' : `
                    <div class="table-container"><table><thead><tr><th>Nome</th><th>Tipo</th><th>Saldo</th><th class="text-right">A√ß√µes</th></tr></thead><tbody>${displayAccounts.map(acc => `<tr><td class="font-medium text-base-color">${acc.name || 'N/A'}</td><td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${acc.type === 'personal' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'}">${acc.type === 'personal' ? 'Pessoal' : 'Empresarial'}</span></td><td class="font-semibold ${calculateBalance(acc.id) >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(calculateBalance(acc.id))}</td><td class="text-right space-x-1"><button class="edit-account-btn btn-icon text-primary table-action-button" data-id="${acc.id}" aria-label="Editar conta ${acc.name}">${ICONS.Edit}</button><button class="delete-account-btn btn-icon text-danger table-action-button" data-id="${acc.id}" aria-label="Excluir conta ${acc.name}">${ICONS.Trash2}</button></td></tr>`).join('')}</tbody></table></div>
                    ${renderPaginationControls(totalItems, totalPages, 'contas')}
                `}`;
            addSearchAndDateFilterListeners('accounts');
            document.getElementById('add-account-btn')?.addEventListener('click', () => openFormModal('accounts', 'add'));
            mainContent.querySelectorAll('.add-new-in-empty-state').forEach(btn => btn.addEventListener('click', () => openFormModal('accounts', 'add')));
            mainContent.querySelectorAll('.edit-account-btn').forEach(btn => btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; const account = accounts.find(a => a.id === id); if (account) openFormModal('accounts', 'edit', account); }));
            mainContent.querySelectorAll('.delete-account-btn').forEach(btn => btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; handleDelete('accounts', id); }));
            addPaginationListeners(totalPages);
        };

        const renderTransactions = () => {
            if (dataLoadingStates.transactions || dataLoadingStates.accounts || dataLoadingStates.categories) { mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader-lg"></div> <span class="ml-3 text-muted">Carregando transa√ß√µes...</span></div>`; return; }
            const { items: displayTransactions, totalItems, totalPages } = getFilteredAndPaginatedData(transactions, 'transactions');
            const getAccountName = (id) => accounts.find(a => a.id === id)?.name || 'N/A';
            const getCategoryName = (id) => categories.find(c => c.id === id)?.name || 'N/A';
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-semibold">Transa√ß√µes</h1><button id="add-transaction-btn" class="btn btn-primary flex items-center space-x-2">${ICONS.PlusCircle}<span>Adicionar Transa√ß√£o</span></button></div>
                ${renderSearchAndDateFilters('transactions')}
                ${displayTransactions.length === 0 && totalItems === 0 && !currentSearchTerm && !currentStartDate && !currentEndDate ? createEmptyState('Transa√ß√£o', 'Transa√ß√µes', () => openFormModal('transactions', 'add'), ICONS.List) : 
                displayTransactions.length === 0 && (totalItems > 0 || currentSearchTerm || currentStartDate || currentEndDate) ? '<p class="text-center text-muted mt-4">Nenhuma transa√ß√£o encontrada com os filtros atuais.</p>' : `
                    <div class="table-container"><table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Tipo</th><th>Valor</th><th>Conta</th><th>Categoria</th><th class="text-right">A√ß√µes</th></tr></thead><tbody>${displayTransactions.map(trans => `<tr><td class="text-muted">${formatDate(trans.date)}</td><td class="font-medium text-base-color">${trans.description || 'N/A'}</td><td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${trans.type === 'income' ? 'bg-success-light text-success-darktext dark:bg-success-light dark:text-success-darktext' : trans.type === 'expense' ? 'bg-danger-light text-danger-darktext dark:bg-danger-light dark:text-danger-darktext' : 'bg-warning-light text-warning-darktext dark:bg-warning-light dark:text-warning-darktext'}">${trans.type === 'income' ? 'Receita' : trans.type === 'expense' ? 'Despesa' : 'Transfer√™ncia'}</span></td><td class="font-semibold ${trans.type === 'income' ? 'text-success' : trans.type === 'expense' ? 'text-danger' : 'text-warning'}">${formatCurrency(trans.amount)}</td><td class="text-muted">${trans.type === 'transfer' ? `${getAccountName(trans.fromAccountId)} &rarr; ${getAccountName(trans.toAccountId)}` : getAccountName(trans.accountId)}</td><td class="text-muted">${trans.categoryId ? getCategoryName(trans.categoryId) : 'N/A'}</td><td class="text-right space-x-1"><button class="edit-transaction-btn btn-icon text-primary table-action-button" data-id="${trans.id}" aria-label="Editar transa√ß√£o ${trans.description}">${ICONS.Edit}</button><button class="delete-transaction-btn btn-icon text-danger table-action-button" data-id="${trans.id}" aria-label="Excluir transa√ß√£o ${trans.description}">${ICONS.Trash2}</button></td></tr>`).join('')}</tbody></table></div>
                    ${renderPaginationControls(totalItems, totalPages, 'transa√ß√µes')}
                `}`;
            addSearchAndDateFilterListeners('transactions');
            document.getElementById('add-transaction-btn')?.addEventListener('click', () => openFormModal('transactions', 'add'));
            mainContent.querySelectorAll('.add-new-in-empty-state').forEach(btn => btn.addEventListener('click', () => openFormModal('transactions', 'add')));
            mainContent.querySelectorAll('.edit-transaction-btn').forEach(btn => btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; const transaction = transactions.find(t => t.id === id); if (transaction) openFormModal('transactions', 'edit', transaction); }));
            mainContent.querySelectorAll('.delete-transaction-btn').forEach(btn => btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; handleDelete('transactions', id); }));
            addPaginationListeners(totalPages);
        };

        const renderCategories = () => {
            if (dataLoadingStates.categories) { mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader-lg"></div> <span class="ml-3 text-muted">Carregando categorias...</span></div>`; return; }
            const { items: displayCategories, totalItems, totalPages } = getFilteredAndPaginatedData(categories, 'categories');
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-semibold">Categorias</h1><button id="add-category-btn" class="btn btn-primary flex items-center space-x-2">${ICONS.PlusCircle}<span>Adicionar Categoria</span></button></div>
                ${renderSearchAndDateFilters('categories')}
                ${displayCategories.length === 0 && totalItems === 0 && !currentSearchTerm ? createEmptyState('Categoria', 'Categorias', () => openFormModal('categories', 'add'), ICONS.Briefcase) : 
                displayCategories.length === 0 && (totalItems > 0 || currentSearchTerm) ? '<p class="text-center text-muted mt-4">Nenhuma categoria encontrada com os filtros atuais.</p>' : `
                    <div class="table-container"><table><thead><tr><th>Nome</th><th>Tipo</th><th>Contexto</th><th class="text-right">A√ß√µes</th></tr></thead><tbody>${displayCategories.map(cat => `<tr><td class="font-medium text-base-color">${cat.name || 'N/A'}</td><td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${cat.type === 'income' ? 'bg-success-light text-success-darktext dark:bg-success-light dark:text-success-darktext' : 'bg-danger-light text-danger-darktext dark:bg-danger-light dark:text-danger-darktext'}">${cat.type === 'income' ? 'Receita' : 'Despesa'}</span></td><td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${cat.context === 'personal' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : cat.context === 'business' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'}">${cat.context === 'personal' ? 'Pessoal' : cat.context === 'business' ? 'Empresarial' : 'Geral'}</span></td><td class="text-right space-x-1"><button class="edit-category-btn btn-icon text-primary table-action-button" data-id="${cat.id}" aria-label="Editar categoria ${cat.name}">${ICONS.Edit}</button><button class="delete-category-btn btn-icon text-danger table-action-button" data-id="${cat.id}" aria-label="Excluir categoria ${cat.name}">${ICONS.Trash2}</button></td></tr>`).join('')}</tbody></table></div>
                    ${renderPaginationControls(totalItems, totalPages, 'categorias')}
                `}`;
            addSearchAndDateFilterListeners('categories');
            document.getElementById('add-category-btn')?.addEventListener('click', () => openFormModal('categories', 'add'));
            mainContent.querySelectorAll('.add-new-in-empty-state').forEach(btn => btn.addEventListener('click', () => openFormModal('categories', 'add')));
            mainContent.querySelectorAll('.edit-category-btn').forEach(btn => btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; const category = categories.find(c => c.id === id); if (category) openFormModal('categories', 'edit', category); }));
            mainContent.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; handleDelete('categories', id); }));
            addPaginationListeners(totalPages);
        };

        const calculateMeiTotalIncome = (startDateStr, endDateStr) => {
            if (!startDateStr || !endDateStr) return 0;

            const startDate = getFirebaseTimestamp(startDateStr).toDate();
            startDate.setHours(0, 0, 0, 0);
            const endDate = getFirebaseTimestamp(endDateStr).toDate();
            endDate.setHours(23, 59, 59, 999);

            let totalIncome = 0;
            transactions.forEach(trans => {
                if (trans.type === 'income') {
                    const account = accounts.find(acc => acc.id === trans.accountId);
                    if (account && account.type === 'business') {
                        const transDate = trans.date?.toDate();
                        if (transDate && transDate >= startDate && transDate <= endDate) {
                            totalIncome += parseFloat(trans.amount || 0);
                        }
                    }
                }
            });
            return totalIncome;
        };

        const renderMeiReport = () => {
            if (dataLoadingStates.transactions || dataLoadingStates.accounts) {
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader-lg"></div> <span class="ml-3 text-muted">Carregando relat√≥rio MEI...</span></div>`;
                return;
            }

            const totalMeiIncome = calculateMeiTotalIncome(meiReportStartDate, meiReportEndDate);

            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-semibold">Relat√≥rio de Faturamento MEI</h1>
                </div>
                <div class="bg-card p-6 rounded-xl shadow-lg">
                    <div class="mei-report-filters">
                        <div>
                            <label for="mei-start-date" class="block text-sm font-medium text-muted">Data In√≠cio</label>
                            <input type="date" id="mei-start-date" value="${meiReportStartDate}" class="text-sm">
                        </div>
                        <div>
                            <label for="mei-end-date" class="block text-sm font-medium text-muted">Data Fim</label>
                            <input type="date" id="mei-end-date" value="${meiReportEndDate}" class="text-sm">
                        </div>
                        <button id="mei-recalculate-btn" class="btn btn-primary btn-sm self-end">Recalcular</button>
                    </div>
                    <hr class="my-6 border-gray-300 dark:border-gray-600">
                    <div>
                        <h2 class="text-xl font-semibold mb-2">Total Faturado (Receitas Empresariais)</h2>
                        <p class="mei-report-value">${formatCurrency(totalMeiIncome)}</p>
                    </div>
                    <p class="mei-report-note">
                        ${ICONS.FileText} Este valor inclui todas as transa√ß√µes do tipo "Receita" associadas a contas do tipo "Empresarial" dentro do per√≠odo selecionado. 
                        Transfer√™ncias entre contas n√£o s√£o consideradas faturamento.
                    </p>
                </div>
            `;

            document.getElementById('mei-start-date')?.addEventListener('change', (e) => {
                meiReportStartDate = e.target.value;
            });
            document.getElementById('mei-end-date')?.addEventListener('change', (e) => {
                meiReportEndDate = e.target.value;
            });
            document.getElementById('mei-recalculate-btn')?.addEventListener('click', () => {
                renderMeiReport(); 
            });
        };


        const renderCurrentView = () => {
            if (!currentUserId && currentView !== 'auth') { 
                console.log("Attempting to render dashboard view without logged-in user. Redirecting to auth.");
                authScreenEl.classList.remove('hidden');
                dashboardScreenEl.classList.add('hidden');
                dashboardScreenEl.classList.remove('flex'); 
                return;
            }
            if (currentView === 'auth') { 
                 authScreenEl.classList.remove('hidden');
                 dashboardScreenEl.classList.add('hidden');
                 dashboardScreenEl.classList.remove('flex'); 
                 updateAuthScreenVisibility(); 
                 return;
            }
            if (currentUserId && currentView !== 'auth') {
                authScreenEl.classList.add('hidden');
                dashboardScreenEl.classList.remove('hidden');
                dashboardScreenEl.classList.add('flex');
            }

            switch (currentView) {
                case 'overview': renderOverview(); break;
                case 'accounts': renderAccounts(); break;
                case 'transactions': renderTransactions(); break;
                case 'categories': renderCategories(); break;
                case 'meiReport': renderMeiReport(); break; 
                default: renderOverview();
            }
        };
        
        // --- Modal Handling ---
        const openModal = (title, contentHTML, onCancel, onConfirm) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = ''; 
            if (typeof contentHTML === 'string') modalBody.innerHTML = contentHTML;
            else modalBody.appendChild(contentHTML);
            
            modalGeneric.style.display = 'flex'; 
            requestAnimationFrame(() => { 
                modalGeneric.classList.add('open');
                const firstFocusable = modalBody.querySelector('input:not([type="hidden"]):not(:disabled), select:not(:disabled), button:not(.modal-cancel-btn):not(#modal-close-button):not(:disabled)');
                if (firstFocusable) firstFocusable.focus();
            });
            
            const newModalCloseButton = modalCloseButton.cloneNode(true);
            modalCloseButton.parentNode.replaceChild(newModalCloseButton, modalCloseButton);
            modalCloseButton = newModalCloseButton; 
            modalCloseButton.onclick = () => closeModal(onCancel);

            const currentCancelBtn = modalBody.querySelector('.modal-cancel-btn');
            if (currentCancelBtn) {
                const newCancelBtn = currentCancelBtn.cloneNode(true);
                currentCancelBtn.parentNode.replaceChild(newCancelBtn, currentCancelBtn);
                newCancelBtn.onclick = () => closeModal(onCancel);
            }
            const currentConfirmBtn = modalBody.querySelector('.modal-confirm-btn');
            if (currentConfirmBtn) {
                const newConfirmBtn = currentConfirmBtn.cloneNode(true);
                currentConfirmBtn.parentNode.replaceChild(newConfirmBtn, currentConfirmBtn);
                newConfirmBtn.onclick = () => { if (onConfirm) onConfirm(); }; 
            }
        };

        const closeModal = (cancelCallback) => {
            modalGeneric.classList.remove('open');
            setTimeout(() => {
                modalGeneric.style.display = 'none';
                modalBody.innerHTML = ''; 
                currentModal = { type: null, mode: null, data: null, callback: null };
                if (cancelCallback && typeof cancelCallback === 'function') cancelCallback();
            }, 250); 
        };

        const openFormModal = (type, mode, data = null) => {
            currentModal = { type, mode, data, callback: null };
            let templateId, title;
            if (type === 'accounts') { templateId = 'account-form-template'; title = `${mode === 'edit' ? 'Editar' : 'Adicionar'} Conta`; }
            else if (type === 'categories') { templateId = 'category-form-template'; title = `${mode === 'edit' ? 'Editar' : 'Adicionar'} Categoria`; }
            else if (type === 'transactions') { templateId = 'transaction-form-template'; title = `${mode === 'edit' ? 'Editar' : 'Adicionar'} Transa√ß√£o`; }
            else return;
            const template = document.getElementById(templateId);
            if (!template) { console.error(`Template ${templateId} not found.`); return; }
            const formClone = template.content.cloneNode(true).querySelector('form');
            if (!formClone) { console.error(`Form not found in template ${templateId}.`); return; }
            formClone.id = `${templateId}-instance`; 

            if (mode === 'edit' && data) { 
                for (const key in data) { 
                    const input = formClone.elements[key]; 
                    if (input) { 
                        if (input.type === 'date' && data[key] instanceof Timestamp) {
                            input.value = dateToInputFormat(data[key]);
                        } else {
                            input.value = data[key]; 
                        }
                    } 
                } 
            } else if (type === 'transactions' && mode === 'add') { 
                const dateInput = formClone.elements['date']; 
                if (dateInput) dateInput.value = dateToInputFormat(new Date());
            }
            
            if (type === 'transactions') {
                const typeSelect = formClone.elements['type']; 
                const accountSelect = formClone.elements['accountId']; 
                const categorySelect = formClone.elements['categoryId']; 
                const fromAccountSelect = formClone.elements['fromAccountId']; 
                const toAccountSelect = formClone.elements['toAccountId']; 
                const accountSection = formClone.querySelector('.transaction-account-section'); 
                const categorySection = formClone.querySelector('.transaction-category-section'); 
                const transferSection = formClone.querySelector('.transaction-transfer-section');
                
                const populateAccountSelects = (currentAccountId = null, currentFromId = null, currentToId = null) => {
                    [accountSelect, fromAccountSelect, toAccountSelect].forEach((sel, index) => { 
                        if(sel) { 
                            let preservedValue = null;
                            if (index === 0) preservedValue = currentAccountId;
                            else if (index === 1) preservedValue = currentFromId;
                            else if (index === 2) preservedValue = currentToId;
                            
                            sel.innerHTML = '<option value="">Selecione...</option>'; 
                            accounts.forEach(acc => {
                                const option = new Option(`${acc.name} (${acc.type === 'personal' ? 'Pessoal' : 'Empresarial'})`, acc.id);
                                sel.add(option);
                            });
                            if (preservedValue) sel.value = preservedValue;
                        } 
                    });
                };
                
                populateAccountSelects(data?.accountId, data?.fromAccountId, data?.toAccountId);

                const updateTransactionFormFields = () => {
                    const currentTransactionType = typeSelect.value;
                    accountSection.classList.toggle('hidden', currentTransactionType === 'transfer');
                    categorySection.classList.toggle('hidden', currentTransactionType === 'transfer');
                    transferSection.classList.toggle('hidden', currentTransactionType !== 'transfer');
                    
                    if (accountSelect) accountSelect.required = currentTransactionType !== 'transfer';
                    if (fromAccountSelect) fromAccountSelect.required = currentTransactionType === 'transfer';
                    if (toAccountSelect) toAccountSelect.required = currentTransactionType === 'transfer';

                    if (currentTransactionType !== 'transfer' && categorySelect) {
                        const currentCategoryValue = categorySelect.value || (mode === 'edit' && data?.categoryId);
                        categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                        const selectedAccountIdForCategory = accountSelect.value;
                        const selectedAccountForCategory = accounts.find(a => a.id === selectedAccountIdForCategory);
                        const accountContextForCategory = selectedAccountForCategory ? selectedAccountForCategory.type : null;
                        
                        categories.filter(cat => cat.type === currentTransactionType && (cat.context === 'all' || (accountContextForCategory && cat.context === accountContextForCategory)))
                            .forEach(cat => categorySelect.add(new Option(cat.name, cat.id)));
                        if(currentCategoryValue) categorySelect.value = currentCategoryValue;
                    }
                };

                typeSelect.addEventListener('change', updateTransactionFormFields); 
                if(accountSelect) accountSelect.addEventListener('change', updateTransactionFormFields); 
                
                if (mode === 'edit' && data) {
                    typeSelect.value = data.type || 'expense'; 
                     if (data.type === 'transfer') {
                        if(fromAccountSelect) fromAccountSelect.value = data.fromAccountId || '';
                        if(toAccountSelect) toAccountSelect.value = data.toAccountId || '';
                    } else {
                        if(accountSelect) accountSelect.value = data.accountId || '';
                        if(categorySelect) categorySelect.value = data.categoryId || '';
                    }
                }
                updateTransactionFormFields(); 
            }

            formClone.onsubmit = async (e) => {
                e.preventDefault(); 
                if (!validateForm(formClone)) return;
                const saveButton = formClone.querySelector('.modal-save-btn');
                const originalButtonText = saveButton.textContent;
                saveButton.disabled = true;
                saveButton.innerHTML = `<span class="loader-sm mr-2"></span> Salvando...`;
                const formData = new FormData(formClone); const itemData = {}; formData.forEach((value, key) => itemData[key] = value.trim());
                
                if (itemData.amount) itemData.amount = parseFloat(itemData.amount); 
                if (itemData.date) itemData.date = getFirebaseTimestamp(itemData.date);
                
                if (itemData.type === 'transfer') { 
                    delete itemData.accountId; 
                    delete itemData.categoryId; 
                } else { 
                    delete itemData.fromAccountId; 
                    delete itemData.toAccountId; 
                    if (!itemData.categoryId) delete itemData.categoryId; 
                }
                try { 
                    await handleSave(type, itemData, data?.id);
                } 
                catch(err) { showNotification(`Erro ao salvar: ${err.message}`, 'error');}
                finally { saveButton.disabled = false; saveButton.innerHTML = originalButtonText; }
            };
            openModal(title, formClone);
        };
        
        const openConfirmationModal = (message, onConfirmCallback) => {
            const template = document.getElementById('confirmation-modal-template'); 
            if (!template) { console.error("Confirmation modal template not found"); return; }
            const contentClone = template.content.cloneNode(true); 
            const msgElement = contentClone.getElementById('confirmation-message');
            if(msgElement) msgElement.textContent = message;
            openModal("Confirma√ß√£o", contentClone, null, () => { onConfirmCallback(); closeModal(); }); 
        };

        // --- CRUD Operations ---
        const handleSave = async (type, dataToSave, existingId = null) => {
            if (!currentUserId) { showNotification("Usu√°rio n√£o autenticado. Opera√ß√£o n√£o permitida.", "error"); return Promise.reject(new Error("Usu√°rio n√£o autenticado")); }
            const collectionPath = getCollectionPath(type);
            try {
                if (existingId) { 
                    const docRef = doc(fbDb, collectionPath, existingId); 
                    await updateDoc(docRef, dataToSave); 
                    showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} atualizada com sucesso!`, 'success'); 
                } else { 
                    await addDoc(collection(fbDb, collectionPath), { ...dataToSave, createdAt: Timestamp.now() }); 
                    showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} adicionada com sucesso!`, 'success'); 
                }
                closeModal(); 
            } catch (error) { 
                console.error(`Error saving ${type}: `, error); 
                showNotification(`Erro ao salvar ${type}: ${error.message}`, 'error'); 
                throw error; 
            }
        };

        const handleDelete = async (type, id) => {
            if (!currentUserId) { showNotification("Usu√°rio n√£o autenticado. Opera√ß√£o n√£o permitida.", "error"); return; }
            openConfirmationModal(`Tem certeza que deseja excluir este item? Esta a√ß√£o n√£o pode ser desfeita.`, async () => {
                try {
                    if (type === 'accounts') { 
                        const hasTransactions = transactions.some(t => t.accountId === id || t.fromAccountId === id || t.toAccountId === id); 
                        if (hasTransactions) { 
                            showNotification('N√£o √© poss√≠vel excluir a conta. Existem transa√ß√µes associadas a ela.', 'error', 5000); 
                            return; 
                        } 
                    }
                    if (type === 'categories') { 
                        const hasTransactions = transactions.some(t => t.categoryId === id); 
                        if (hasTransactions) { 
                            showNotification('N√£o √© poss√≠vel excluir a categoria. Existem transa√ß√µes associadas a ela.', 'error', 5000); 
                            return; 
                        } 
                    }
                    const collectionPath = getCollectionPath(type); 
                    await deleteDoc(doc(fbDb, collectionPath, id)); 
                    showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} exclu√≠da com sucesso!`, 'success'); 
                } catch (error) { 
                    console.error(`Error deleting ${type}: `, error); 
                    showNotification(`Erro ao excluir ${type}: ${error.message}`, 'error'); 
                }
            });
        };

        // --- App Initialization ---
        const initializeAppUI = () => {
            document.getElementById('app-title-auth').textContent = APP_NAME_CONST; 
            const appTitleDashboard = document.getElementById('app-title-dashboard');
            if(appTitleDashboard) appTitleDashboard.textContent = APP_NAME_CONST;
            if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear(); 
            
            renderSidebar(); 
            renderToggleBalancesButton(); 
            applyDarkModePreference(); 
            updateFilterContextButtons();
            
            adminControlsSection.classList.toggle('hidden', userRole !== 'admin');
            updateRegistrationToggleUI(); 

            document.querySelectorAll('.filter-context-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const newContext = e.target.dataset.context;
                    if (filterContext !== newContext || currentView !== 'overview') {
                        filterContext = newContext;         
                        updateFilterContextButtons();       
                        navigateTo('overview');             
                    }
                });
            });

            toggleBalancesBtn.addEventListener('click', () => { showBalances = !showBalances; renderToggleBalancesButton(); renderCurrentView(); });
            darkModeToggleBtn.addEventListener('click', () => { 
                const isDarkMode = document.body.classList.toggle('dark');
                localStorage.setItem('darkMode', isDarkMode.toString());
                applyDarkModePreference();
            });
            
            if (modalCloseButton) {
                modalCloseButton.onclick = () => closeModal();
            }
            if (modalGeneric) {
                modalGeneric.addEventListener('click', (event) => { 
                    if (event.target === modalGeneric) closeModal(); 
                });
            }
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modalGeneric.classList.contains('open')) {
                    closeModal();
                }
            });
            navigateTo('overview'); 
        };

        onAuthStateChanged(fbAuth, async (user) => {
            await fetchRegistrationSettings(); 
            console.log("onAuthStateChanged triggered. User:", user ? user.uid : "None", "Reg Enabled:", registrationsEnabled); 
            
            cleanupFirestoreListeners(); 
            accounts = []; categories = []; transactions = []; 
            dataLoadingStates = { accounts: true, categories: true, transactions: true }; 
            currentPage = 1; currentSearchTerm = ''; 
            
            const today = new Date();
            currentStartDate = dateToInputFormat(new Date(today.getFullYear(), today.getMonth(), 1));
            currentEndDate = dateToInputFormat(new Date(today.getFullYear(), today.getMonth() + 1, 0));
            meiReportStartDate = dateToInputFormat(new Date(today.getFullYear(), 0, 1));
            meiReportEndDate = dateToInputFormat(new Date(today.getFullYear(), 11, 31));


            if (user) { 
                currentUser = user; currentUserId = user.uid; 
                
                if (user.uid === ADMIN_UID) {
                    userRole = 'admin';
                    const adminProfileRef = doc(fbDb, "users", ADMIN_UID);
                    const adminProfileSnap = await getDoc(adminProfileRef);
                    if (!adminProfileSnap.exists() || adminProfileSnap.data().role !== 'admin') {
                        await createUserProfile(user, 'admin');
                    }
                } else {
                    userRole = await fetchUserProfile(user.uid); 
                }
                console.log("User logged in:", currentUserId, user.email, "Role:", userRole);

                userEmailDisplay.textContent = user.email || (user.isAnonymous ? 'Usu√°rio An√¥nimo' : 'N/A'); 
                userEmailDisplay.title = user.email || (user.isAnonymous ? 'Usu√°rio An√¥nimo' : 'N/A');
                userIdDisplay.textContent = currentUserId; 
                userIdDisplay.title = currentUserId;
                userRoleDisplay.textContent = userRole === 'admin' ? 'Admin' : 'Membro';
                
                initializeAppUI(); 
                
                fetchData('accounts', (data) => accounts = data); 
                fetchData('categories', (data) => categories = data); 
                fetchData('transactions', (data) => transactions = data, () => {
                    if (currentView !== 'auth') renderCurrentView();
                });
            } else { 
                currentUser = null; currentUserId = null; userRole = 'member'; 
                console.log("No user logged in. Displaying auth screen.");
                dashboardScreenEl.classList.add('hidden'); 
                dashboardScreenEl.classList.remove('flex'); 
                authScreenEl.classList.remove('hidden'); 
                adminControlsSection.classList.add('hidden'); 
                updateAuthScreenVisibility(); 
            }
        });
        
        applyDarkModePreference(); 
        console.log("Financial Manager Ultra script loaded and ready.");
    </script>
</body>
</html>
